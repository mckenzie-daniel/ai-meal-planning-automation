# Airtable Database Schema

## Overview

The database consists of 4 tables that work together to manage recipes, weekly meal plans, shopping lists, and user preferences.

---

## Table 1: Recipes (~70 records)

**Purpose:** Master list of all available recipes with metadata for intelligent selection

### Fields

| Field Name | Type | Description | Example Values |
|------------|------|-------------|----------------|
| Recipe Name | Single line text | Name of the recipe | "Korean Beef Bowl", "Grilled Chicken" |
| Meal Type | Single select | When this recipe is appropriate | Dinner, Lunch, Breakfast |
| Recipe Role | Single select | Main dish or side | Main Dish, Side Dish |
| Health Score | Number | 1-10 scale for healthiness | 7, 8, 5 |
| Effort Level | Single select | Time/complexity required | Low, Medium, High |
| Primary Protein | Single select | Main protein source | Chicken, Beef, Pork, Fish, Vegetarian |
| Type of Food | Single line text | Cuisine or style | Mexican, Italian, American, Asian |
| Last Planned Date | Date | When this recipe was last used | 2026-01-12 |
| Times Planned for Dinner | Rollup | Count of times used (deprecated) | - |
| Times Actually Cooked | Number | Manual tracking (not automated) | - |
| Needs Sides? | Checkbox | Does this main dish need sides | ☑ or ☐ |
| Number of Sides Needed | Number | How many sides to pair | 1, 2 |
| Suggested Sides | Linked records | Link to other recipes (sides) | → Recipes table |
| Side Type | Single select | Category of side dish | Starch, Vegetable, Salad, Fruit |
| Ingredient List | Long text | All ingredients with quantities | "2 lbs ground beef\n1 onion\n..." |

### Key Relationships

- **Suggested Sides** → Links to other records in Recipes table where Recipe Role = "Side Dish"
- **Used by Weekly Plans** → Reverse link from Weekly Plans table

### Business Logic

**Last Planned Date:**
- Updated automatically after each weekly plan generation
- Used by Claude to avoid recent repetition (14-day recency rule)
- Critical for variety tracking

**Suggested Sides:**
- Only populated when Needs Sides = TRUE
- Links to recipes where Recipe Role = "Side Dish"
- Claude selects from these options ensuring Side Type diversity

**Health Score:**
- Subjective 1-10 rating
- Claude averages across selected recipes to hit target
- Example: 7 dinners × 7.0 avg health score = 49 total points

---

## Table 2: Weekly Plans (generated weekly)

**Purpose:** Stores each week's meal plan with selected recipes and shopping list

### Fields

| Field Name | Type | Description |
|------------|------|-------------|
| Week Starting Date | Date | Monday of the week | 2026-01-13 |
| Dinners Planned | Linked records | 5 main dishes + sides | → Recipes table |
| Lunches Planned | Linked records | 2 lunch recipes | → Recipes table |
| Breakfasts Planned | Linked records | 2 breakfast recipes | → Recipes table |
| Plan Shopping List | Long text | Formatted grocery list | "PRODUCE\n• 2 lbs tomatoes..." |
| Reasoning Message | Long text | Claude's explanation | "Selected Korean Beef because..." |
| Plan Generated By | Single line text | Always "AI" | AI |
| Plan Health Score | Number | Calculated average | 7.2 |

### Key Relationships

- **Dinners/Lunches/Breakfasts Planned** → Links to Recipes table
- Each weekly plan can link to 9+ recipes (5 dinners + sides, 2 lunches, 2 breakfasts)

### Workflow

1. **Sunday 9am:** Make.com scenario creates new Weekly Plan record
2. **Claude selects recipes** → Links populated via API
3. **Shopping list generated** → Stored in Plan Shopping List field
4. **Reasoning captured** → Stored in Reasoning Message field
5. **User can manually adjust** → Swap recipe links, click "Regenerate Shopping List" button

---

## Table 3: Shopping List Additions

**Purpose:** Track staples and one-off items to include in weekly shopping list

### Fields

| Field Name | Type | Description | Example |
|------------|------|-------------|---------|
| Item | Single line text | Name of item | Milk, Eggs, Paper towels |
| Quantity | Single line text | How much | 1 gallon, 1 dozen |
| Category | Single select | Grocery category | Dairy, Produce, Household |
| Always Include? | Checkbox | Include every week | ☑ (for milk, eggs, bananas) |
| Include this week? | Checkbox | One-off addition | ☑ (for special occasions) |

### Business Logic

**Always Include:**
- Staples that are purchased weekly regardless of recipes
- Examples: Milk, eggs, bananas, bread
- Automatically included in every shopping list

**Include this week:**
- One-off additions for special needs
- Examples: "Birthday cake supplies", "Extra ground beef"
- Checkbox is reset after each weekly plan generation
- If user clicks "Regenerate Shopping List" button, these items won't be included again (unless manually re-checked)

**Integration with Claude:**
- All checked items sent to Claude API for shopping list generation
- Claude merges these with recipe ingredients
- Organized by Category

---

## Table 4: User Preferences (single record)

**Purpose:** Configure weekly meal planning parameters

### Fields

| Field Name | Type | Description | Example Value |
|------------|------|-------------|---------------|
| Number of Dinners to Plan | Number | How many dinners per week | 5 |
| Number of Lunches to Plan | Number | How many lunches per week | 2 |
| Number of Breakfasts to Plan | Number | How many breakfasts per week | 2 |
| Target Weekly Health Score | Number | Average health score goal | 7.0 |
| Max High Effort Meals per Week | Number | Limit complex recipes | 1 |
| Pantry Surplus or Preference | Long text | What's already on hand | "lots of ground beef" |
| Recipe Search Preferences | Long text | Weekly specific requests | "need grilled cheese Wednesday" |

### Usage

**Static Configuration:**
- Number of meals per type (rarely changes)
- Target health score (weekly average goal)
- Max high effort meals (to avoid cooking fatigue)

**Dynamic Weekly Input:**
- **Pantry Surplus:** "We have 5 lbs ground beef to use up"
- **Recipe Search Preferences:** Natural language requests
  - "Need something for grilling Wednesday"
  - "Want tacos this week"
  - "Craving Asian food"
  - "Use up the ground beef"

**How Claude Uses This:**
- Static config = hard constraints (must select exactly 5 dinners)
- Dynamic preferences = soft constraints (honor when possible)
- Preferences can't override meal type integrity or recency rules

---

## Data Flow

### Weekly Plan Generation Flow

```
1. Make.com retrieves:
   ├── User Preferences (all fields)
   ├── All Recipes (filtered by Meal Type if needed)
   └── Shopping List Additions (where Always Include = TRUE or Include this week = TRUE)

2. Data aggregated into text format for Claude

3. Claude API Call #1: Recipe Selection
   ├── Input: User preferences + Available recipes + Current date
   ├── Processing: Multi-constraint optimization
   └── Output: JSON with recipe IDs

4. Make.com parses JSON response

5. For each selected recipe:
   ├── Retrieve Ingredient List from Recipes table
   └── Aggregate all ingredients into text

6. Claude API Call #2: Shopping List Generation
   ├── Input: All ingredients + Shopping List Additions
   ├── Processing: Consolidate duplicates, organize by category
   └── Output: Formatted shopping list text

7. Create new Weekly Plan record:
   ├── Link selected recipes
   ├── Store shopping list
   └── Capture reasoning

8. Update Recipe metadata:
   ├── Set Last Planned Date = today
   └── (Run 3 parallel iterator flows for dinners/lunches/breakfasts)

9. Reset Shopping List Additions:
   └── Uncheck "Include this week?" for all items
```

---

## Schema Evolution

### Deprecated Fields

**Times Planned for Dinner** (Rollup field)
- Originally tracked how many times each recipe was used
- Replaced by "Last Planned Date" which is simpler and more effective
- Issue: Make.com couldn't update rollup fields (computed)
- Removed from automation workflow

**Times Actually Cooked** (Number field)
- Manual tracking of what we actually cooked vs planned
- Not automated, requires manual input
- Rarely updated in practice
- Kept for potential future use but not actively used

### Why Last Planned Date Works Better

**Original Approach:**
- Track "Times Planned" count
- Avoid recipes with high counts
- **Problem:** Doesn't account for recency (could use recipe twice in first month then never again)

**Current Approach:**
- Track "Last Planned Date"
- Avoid recipes within 14 days
- **Benefit:** Ensures variety over time, simpler logic

**Example:**
- Recipe pool: 8 lunch recipes
- 2 lunches per week = 4 weeks until rotation complete
- After 4 weeks, oldest recipe is 28 days old (outside 14-day window)
- System naturally rotates through all recipes

---

## Schema Design Decisions

### Why Linked Records vs Lists

**Decision:** Use Airtable's linked records for recipe relationships instead of storing lists

**Reasoning:**
- Can query recipe details (ingredients, metadata) in Make.com
- Changes to recipe propagate to all plans that use it
- Easy to see which weeks used which recipes (reverse relationships)
- Better data integrity than storing recipe names as text

### Why Single User Preferences Record

**Decision:** Single record instead of config per week

**Reasoning:**
- Most preferences are stable (number of meals, health targets)
- Weekly preferences stored in text fields (flexible, natural language)
- Simpler to query in Make.com (no filtering needed)
- Can track preference history if needed (Airtable versioning)

### Why Separate Shopping List Additions Table

**Decision:** Separate table instead of fields in User Preferences

**Reasoning:**
- Each item is a distinct entity with properties (quantity, category)
- Can have unlimited items (not limited by field count)
- Easier to manage in Airtable interface (grid view)
- Better for future enhancements (item history, pricing, store mapping)

---

## Database Maintenance

### Manual Operations

**Adding New Recipes:**
1. Create new record in Recipes table
2. Fill required fields: Name, Meal Type, Recipe Role, Ingredient List
3. Set metadata: Health Score, Effort Level, Primary Protein
4. If main dish needs sides: Check "Needs Sides", link to Suggested Sides

**Marking Recipe as "Never Again":**
- Currently: Just delete the record
- Future: Add Status field (Active/Never Again/On Hold)

**Adjusting Weekly Preferences:**
- Edit Recipe Search Preferences field before Sunday 9am
- Examples: "Use up ground beef", "Need quick meals this week"

### Automated Operations

**Every Sunday 9am MST:**
- Create new Weekly Plan record
- Update Last Planned Date for all selected recipes
- Reset "Include this week?" checkboxes

**User-Triggered (Regenerate Button):**
- Recalculate shopping list based on current recipe selections
- Does NOT update Last Planned Date
- Does NOT reset shopping list checkboxes

---

## Schema for Reference

**Recipes** (70 records)
```
├── Recipe Name [text]
├── Meal Type [select: Dinner/Lunch/Breakfast]
├── Recipe Role [select: Main Dish/Side Dish]
├── Health Score [number: 1-10]
├── Effort Level [select: Low/Medium/High]
├── Primary Protein [select: Chicken/Beef/Pork/Fish/Vegetarian]
├── Type of Food [text]
├── Last Planned Date [date] ← CRITICAL for variety
├── Needs Sides? [checkbox]
├── Number of Sides Needed [number]
├── Suggested Sides [linked records → Recipes]
├── Side Type [select: Starch/Vegetable/Salad/Fruit]
└── Ingredient List [long text]
```

**Weekly Plans** (generated weekly)
```
├── Week Starting Date [date]
├── Dinners Planned [linked records → Recipes]
├── Lunches Planned [linked records → Recipes]
├── Breakfasts Planned [linked records → Recipes]
├── Plan Shopping List [long text]
├── Reasoning Message [long text]
├── Plan Generated By [text: "AI"]
└── Plan Health Score [number]
```

**Shopping List Additions**
```
├── Item [text]
├── Quantity [text]
├── Category [select]
├── Always Include? [checkbox]
└── Include this week? [checkbox]
```

**User Preferences** (single record)
```
├── Number of Dinners to Plan [number: 5]
├── Number of Lunches to Plan [number: 2]
├── Number of Breakfasts to Plan [number: 2]
├── Target Weekly Health Score [number: 7.0]
├── Max High Effort Meals per Week [number: 1]
├── Pantry Surplus or Preference [long text]
└── Recipe Search Preferences [long text]
```
